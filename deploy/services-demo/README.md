# How to run `wire-server` with "fake" AWS dependencies

This document assumes that you have already compiled all services (i.e., you ran `make services` from the top level folder) and now you want to see how it all fits together.


Use 2 different terminals and run:

```
# On terminal 1, start the dependencies
(cd ../docker-ephemeral; docker-compose up)
```

```
# On terminal 2, start the services
./demo.sh
```

### Structure of the services-demo folder

```
.
conf                                 <- folder with configuration for all services
  └── nginz
        ├── nginx.conf               <- main nginx configuration
        ├── ...                      <- other nginx config files
        ├── upstreams                <- nginx upstream configuration
  ├── <service>.demo.yaml            <- service configuration file (brig, cannon, cargohold, galley, gundeck, proxy)
resources                            <- folder which contains secrets or other resources used by services
  ├── templates                      <- email/sms/call templates used by brig
  ├── turn							 <- list of TURN servers available and a secret (autogenerated by demo.sh, used by brig and TURN server)
  ├── zauth                          <- public/private keys used for authentication (autogenerated by demo.sh, used by brig and nginz)
  ├── nexmo-credentials.yaml         <- dummy credentials for the nexmo API (used by brig)
  ├── proxy.config                   <- dummy credentials for multiple proxied services (used by proxy)
  ├── twilio-credentials.yaml        <- dummy credentials for the twilio API (used by brig)
├── demo.sh                          <- bash script that generates needed secrets and starts all services
└── README.md                        <- this file
```

### This is fantastic, all services up & running... what now, can I run some kind of smoketests?

Short answer: yes and no. At the moment, you need _one_ AWS service in order to test your cluster with our automated smoketester tool. The `sesEndpoint` in `brig`'s [example configuration](https://github.com/wireapp/wire-server/blob/develop/services/brig/brig.integration.yaml) needs to point to a real AWS SES endpoint.

In your environment, you can configure `AWS_REGION`, `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` for your correct AWS account. Note that there are other ways to specify these credentials (to be detailed later).

Then, have a look at what the configuration for the [api-smoketest](../../tools/api-simulations/README.md) should be. Once you have the correct `mailboxes.json`, this should just work from the top level directory (note the `sender-email` must match brig's [sender-email](https://github.com/wireapp/wire-server/blob/develop/services/brig/brig.integration.yaml#L35))

```
# 
../../dist/api-smoketest --api-host=127.0.0.1 --api-port=8080 --api-websocket-host=127.0.0.1 --api-websocket-port=8081 --mailbox-config=<path_to_mailboxes_file> --sender-email=backend-integration@wire.com --enable-asserts
```

### Common problems

> `"Schema Version too old! Expecting at least: <...>, but got: <...>"` when running `./demo.sh`.

If there are schema changes and you don't force pull the docker migrations, you may run out of sync. We recommend that you run the following:

`docker-compose pull && docker-compose up`

Which will ensure that your DB schema is up to date.

> nginx: [alert] could not open error log file: open() "/var/log/nginz/error.log" failed (2: No such file or directory)

...
